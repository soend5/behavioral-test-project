// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户与权限
model User {
  id            String   @id @default(cuid())
  role          String   // 'admin' | 'coach'
  username      String   @unique
  passwordHash  String   @map("password_hash")
  status        String   @default("active") // 'active' | 'inactive'
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // 关系
  customers     Customer[]
  invites       Invite[]
  attempts      Attempt[]
  coachTags     CoachTag[]
  auditLogs     AuditLog[] @relation("ActorUser")

  @@map("users")
}

// 客户
model Customer {
  id        String   @id @default(cuid())
  name      String?
  nickname  String?
  phone     String?
  wechat    String?
  qq        String?
  note      String?
  coachId   String   @map("coach_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关系
  coach     User     @relation(fields: [coachId], references: [id])
  invites   Invite[]
  attempts  Attempt[]
  coachTags CoachTag[]

  @@map("customers")
}

// 邀请
model Invite {
  id          String   @id @default(cuid())
  tokenHash   String   @unique @map("token_hash")
  status      String   // 'active' | 'entered' | 'completed' | 'expired'
  customerId  String   @map("customer_id")
  coachId     String   @map("coach_id")
  version     String   // 'fast' | 'pro'
  quizVersion String   @map("quiz_version")
  createdAt   DateTime @default(now()) @map("created_at")
  expiresAt   DateTime? @map("expires_at")

  // 关系
  customer    Customer @relation(fields: [customerId], references: [id])
  coach       User     @relation(fields: [coachId], references: [id])
  attempts    Attempt[]

  @@map("invites")
}

// 测评作答与结果
model Attempt {
  id              String   @id @default(cuid())
  inviteId        String   @map("invite_id")
  customerId      String   @map("customer_id")
  coachId         String   @map("coach_id")
  version         String   // 'fast' | 'pro'
  quizVersion     String   @map("quiz_version")
  startedAt       DateTime @map("started_at")
  submittedAt     DateTime? @map("submitted_at")
  answersJson     String?  @map("answers_json") // JSON string
  scoresJson      String?  @map("scores_json") // JSON string
  tagsJson        String?  @map("tags_json") // JSON string
  stage           String?  // 'pre' | 'mid' | 'post'
  matchedSopId    String?  @map("matched_sop_id")
  resultSummaryJson String? @map("result_summary_json") // JSON string

  // 关系
  invite          Invite   @relation(fields: [inviteId], references: [id])
  customer        Customer @relation(fields: [customerId], references: [id])
  coach           User     @relation(fields: [coachId], references: [id])

  @@map("attempts")
}

// 助教主观标签
model CoachTag {
  id         String   @id @default(cuid())
  customerId String   @map("customer_id")
  coachId    String   @map("coach_id")
  tagKey     String   @map("tag_key")
  createdAt  DateTime @default(now()) @map("created_at")

  // 关系
  customer   Customer @relation(fields: [customerId], references: [id])
  coach      User     @relation(fields: [coachId], references: [id])

  @@map("coach_tags")
}

// SOP 配置表
model SopDefinition {
  sopId          String   @id @map("sop_id")
  sopName        String   @map("sop_name")
  sopStage       String   @map("sop_stage")
  status         String   @default("active")
  priority       Int      @default(0)
  stateSummary   String?  @map("state_summary")
  coreGoal       String?  @map("core_goal")
  strategyListJson String? @map("strategy_list_json") // JSON array
  forbiddenListJson String? @map("forbidden_list_json") // JSON array
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // 关系
  rules          SopRule[]
  stageMaps      SopStageMap[]

  @@map("sop_definition")
}

model SopRule {
  ruleId          String   @id @map("rule_id")
  sopId           String   @map("sop_id")
  requiredStage   String?  @map("required_stage")
  requiredTagsJson String? @map("required_tags_json") // JSON array
  excludedTagsJson String? @map("excluded_tags_json") // JSON array
  confidence      Int      @default(0)
  status          String   @default("active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // 关系
  sop             SopDefinition @relation(fields: [sopId], references: [sopId])

  @@map("sop_rule")
}

model CoachingStage {
  stageId      String   @id @map("stage_id")
  stageName    String   @map("stage_name")
  stageDesc    String?  @map("stage_desc")
  uiColor      String?  @map("ui_color")
  allowActions String?  @map("allow_actions") // JSON array
  forbidActions String? @map("forbid_actions") // JSON array
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关系
  sopStageMaps SopStageMap[]

  @@map("coaching_stage")
}

model SopStageMap {
  id        String   @id @default(cuid())
  sopId     String   @map("sop_id")
  stageId   String   @map("stage_id")
  isDefault Boolean  @default(false) @map("is_default")
  remark    String?
  createdAt DateTime @default(now()) @map("created_at")

  // 关系
  sop       SopDefinition @relation(fields: [sopId], references: [sopId])
  stage     CoachingStage @relation(fields: [stageId], references: [stageId])

  @@map("sop_stage_map")
}

// 题库
model Quiz {
  id          String   @id @default(cuid())
  quizVersion String   @map("quiz_version")
  version     String   // 'fast' | 'pro'
  title       String
  status      String   @default("active")
  createdAt   DateTime @default(now()) @map("created_at")

  // 关系
  questions   Question[]

  @@map("quiz")
}

model Question {
  id        String   @id @default(cuid())
  quizId    String   @map("quiz_id")
  orderNo   Int      @map("order_no")
  stem      String
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at")

  // 关系
  quiz      Quiz     @relation(fields: [quizId], references: [id])
  options   Option[]

  @@map("questions")
}

model Option {
  id              String   @id @default(cuid())
  questionId      String   @map("question_id")
  orderNo         Int      @map("order_no")
  text            String
  scorePayloadJson String?  @map("score_payload_json") // JSON object
  createdAt       DateTime @default(now()) @map("created_at")

  // 关系
  question        Question @relation(fields: [questionId], references: [id])

  @@map("options")
}

// 审计日志
model AuditLog {
  id           String   @id @default(cuid())
  actorUserId  String   @map("actor_user_id")
  action       String
  targetType   String?  @map("target_type")
  targetId     String?  @map("target_id")
  metaJson     String?  @map("meta_json") // JSON object
  createdAt    DateTime @default(now()) @map("created_at")

  // 关系
  actorUser    User     @relation("ActorUser", fields: [actorUserId], references: [id])

  @@map("audit_log")
}

