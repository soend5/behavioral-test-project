// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")   // 给线上运行（可用 pooler）
  directUrl = env("DIRECT_URL")     // 给 migrate/seed（必须直连）
}


// 用户与权限
model User {
  id            String   @id @default(cuid())
  role          String   // 'admin' | 'coach'
  username      String   @unique
  passwordHash  String   @map("password_hash")
  status        String   @default("active") // 'active' | 'inactive'
  name          String?  // 助教显示名称
  wechatQrcode  String?  @map("wechat_qrcode") // 微信二维码图片 URL
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // 关系
  customers     Customer[]
  invites       Invite[]
  attempts      Attempt[]
  coachTags     CoachTag[]
  auditLogs     AuditLog[] @relation("ActorUser")

  @@map("users")
}

// 客户
model Customer {
  id        String   @id @default(cuid())
  name      String?
  nickname  String?
  phone     String?
  wechat    String?
  qq        String?
  note      String?
  coachId   String   @map("coach_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关系
  coach        User          @relation(fields: [coachId], references: [id])
  invites      Invite[]
  attempts     Attempt[]
  coachTags    CoachTag[]
  followUpLogs FollowUpLog[]
  segments     CustomerSegment[]
  enrollments  TrainingEnrollment[]

  @@index([coachId])
  @@map("customers")
}

// 邀请
model Invite {
  id          String   @id @default(cuid())
  tokenHash   String   @unique @map("token_hash")
  status      String   // 'active' | 'entered' | 'completed' | 'expired'
  customerId  String   @map("customer_id")
  coachId     String   @map("coach_id")
  version     String   // 'fast' | 'pro'
  quizVersion String   @map("quiz_version")
  createdAt   DateTime @default(now()) @map("created_at")
  expiresAt   DateTime? @map("expires_at")

  // 关系
  customer    Customer @relation(fields: [customerId], references: [id])
  coach       User     @relation(fields: [coachId], references: [id])
  attempts    Attempt[]

  @@index([coachId, status, createdAt])
  @@index([customerId, version, status])
  @@map("invites")
}

// 测评作答与结果
model Attempt {
  id              String   @id @default(cuid())
  inviteId        String   @map("invite_id")
  customerId      String   @map("customer_id")
  coachId         String   @map("coach_id")
  version         String   // 'fast' | 'pro'
  quizVersion     String   @map("quiz_version")
  startedAt       DateTime @map("started_at")
  submittedAt     DateTime? @map("submitted_at")
  answersJson     String?  @map("answers_json") // JSON string
  scoresJson      String?  @map("scores_json") // JSON string
  tagsJson        String?  @map("tags_json") // JSON string
  stage           String?  // 'pre' | 'mid' | 'post'
  matchedSopId    String?  @map("matched_sop_id")
  resultSummaryJson String? @map("result_summary_json") // JSON string

  // 关系
  invite          Invite   @relation(fields: [inviteId], references: [id])
  customer        Customer @relation(fields: [customerId], references: [id])
  coach           User     @relation(fields: [coachId], references: [id])

  @@index([inviteId, submittedAt, startedAt])
  @@index([customerId, submittedAt])
  @@index([coachId, submittedAt])
  @@map("attempts")
}

// 助教主观标签
model CoachTag {
  id         String   @id @default(cuid())
  customerId String   @map("customer_id")
  coachId    String   @map("coach_id")
  tagKey     String   @map("tag_key")
  createdAt  DateTime @default(now()) @map("created_at")

  // 关系
  customer   Customer @relation(fields: [customerId], references: [id])
  coach      User     @relation(fields: [coachId], references: [id])

  @@unique([customerId, coachId, tagKey])
  @@map("coach_tags")
}

// SOP 配置表
model SopDefinition {
  sopId          String   @id @map("sop_id")
  sopName        String   @map("sop_name")
  sopStage       String   @map("sop_stage")
  status         String   @default("active")
  priority       Int      @default(0)
  stateSummary   String?  @map("state_summary")
  coreGoal       String?  @map("core_goal")
  strategyListJson String? @map("strategy_list_json") // JSON array
  forbiddenListJson String? @map("forbidden_list_json") // JSON array
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // 关系
  rules          SopRule[]
  stageMaps      SopStageMap[]
  scripts        ScriptTemplate[]  // v2.0: 关联话术

  @@index([status, sopStage, priority])
  @@map("sop_definition")
}

model SopRule {
  ruleId          String   @id @map("rule_id")
  sopId           String   @map("sop_id")
  requiredStage   String?  @map("required_stage")
  requiredTagsJson String? @map("required_tags_json") // JSON array
  excludedTagsJson String? @map("excluded_tags_json") // JSON array
  confidence      Int      @default(0)
  status          String   @default("active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // 关系
  sop             SopDefinition @relation(fields: [sopId], references: [sopId])

  @@index([status, requiredStage, sopId])
  @@map("sop_rule")
}

model CoachingStage {
  stageId      String   @id @map("stage_id")
  stageName    String   @map("stage_name")
  stageDesc    String?  @map("stage_desc")
  uiColor      String?  @map("ui_color")
  allowActions String?  @map("allow_actions") // JSON array
  forbidActions String? @map("forbid_actions") // JSON array
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关系
  sopStageMaps SopStageMap[]

  @@map("coaching_stage")
}

model SopStageMap {
  id        String   @id @default(cuid())
  sopId     String   @map("sop_id")
  stageId   String   @map("stage_id")
  isDefault Boolean  @default(false) @map("is_default")
  remark    String?
  createdAt DateTime @default(now()) @map("created_at")

  // 关系
  sop       SopDefinition @relation(fields: [sopId], references: [sopId])
  stage     CoachingStage @relation(fields: [stageId], references: [stageId])

  @@unique([sopId, stageId])
  @@index([stageId, isDefault])
  @@map("sop_stage_map")
}

// 题库
model Quiz {
  id          String   @id @default(cuid())
  quizVersion String   @map("quiz_version")
  version     String   // 'fast' | 'pro'
  title       String
  status      String   @default("active")
  createdAt   DateTime @default(now()) @map("created_at")

  // 关系
  questions   Question[]

  @@unique([quizVersion, version])
  @@index([status])
  @@map("quiz")
}

model Question {
  id        String   @id @default(cuid())
  quizId    String   @map("quiz_id")
  stableId  String   @map("stable_id")
  orderNo   Int      @map("order_no")
  stem      String
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at")

  // 关系
  quiz      Quiz     @relation(fields: [quizId], references: [id])
  options   Option[]

  @@unique([quizId, stableId])
  @@unique([quizId, orderNo])
  @@index([quizId, status])
  @@map("questions")
}

model Option {
  id              String   @id @default(cuid())
  questionId      String   @map("question_id")
  stableId        String   @map("stable_id")
  orderNo         Int      @map("order_no")
  text            String
  scorePayloadJson String?  @map("score_payload_json") // JSON object
  createdAt       DateTime @default(now()) @map("created_at")

  // 关系
  question        Question @relation(fields: [questionId], references: [id])

  @@unique([questionId, stableId])
  @@unique([questionId, orderNo])
  @@map("options")
}

// 审计日志
model AuditLog {
  id           String   @id @default(cuid())
  actorUserId  String   @map("actor_user_id")
  action       String
  targetType   String?  @map("target_type")
  targetId     String?  @map("target_id")
  metaJson     String?  @map("meta_json") // JSON object
  createdAt    DateTime @default(now()) @map("created_at")

  // 关系
  actorUser    User     @relation("ActorUser", fields: [actorUserId], references: [id])

  @@index([actorUserId, createdAt])
  @@index([action, createdAt])
  @@map("audit_log")
}

// --- Content assets (v1) ---
model Archetype {
  id              String   @id @default(cuid())
  key             String
  titleCn         String   @map("title_cn")
  oneLinerCn      String   @map("one_liner_cn")
  traitsCn        Json     @map("traits_cn")
  risksCn         Json     @map("risks_cn")
  coachGuidanceCn Json     @map("coach_guidance_cn")
  version         String
  status          String   @default("active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([key, version])
  @@index([status, version])
  @@map("archetypes")
}

model TrainingHandbook {
  id        String   @id @default(cuid())
  version   String   @unique
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  days TrainingDay[]

  @@map("training_handbook")
}

model TrainingDay {
  id          String   @id @default(cuid())
  handbookId  String   @map("handbook_id")
  dayNo       Int      @map("day_no")
  titleCn     String   @map("title_cn")
  goalCn      String   @map("goal_cn")
  doListCn    Json     @map("do_list_cn")
  dontListCn  Json     @map("dont_list_cn")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  handbook TrainingHandbook @relation(fields: [handbookId], references: [id], onDelete: Cascade)
  sections TrainingSection[]

  @@unique([handbookId, dayNo])
  @@index([handbookId, dayNo])
  @@map("training_day")
}

model TrainingSection {
  id        String   @id @default(cuid())
  dayId     String   @map("day_id")
  orderNo   Int      @map("order_no")
  titleCn   String   @map("title_cn")
  bulletsCn Json     @map("bullets_cn")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  day TrainingDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  @@unique([dayId, orderNo])
  @@index([dayId])
  @@map("training_section")
}

model MethodologyDoc {
  id        String   @id @default(cuid())
  version   String   @unique
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sections MethodologySection[]

  @@map("methodology_doc")
}

model MethodologySection {
  id              String   @id @default(cuid())
  docId           String   @map("doc_id")
  slug            String
  titleCn         String   @map("title_cn")
  contentMarkdown String   @map("content_markdown")
  orderNo         Int      @map("order_no")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  doc MethodologyDoc @relation(fields: [docId], references: [id], onDelete: Cascade)

  @@unique([docId, slug])
  @@unique([docId, orderNo])
  @@index([docId])
  @@map("methodology_section")
}

model SystemSetting {
  key       String   @id
  value     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// --- v1.6: 话术库 ---
model ScriptTemplate {
  id               String   @id @default(cuid())
  name             String                              // "首次沟通-规则执行型"
  category         String                              // "首次沟通" / "跟进" / "转化" / "复测"
  triggerStage     String?  @map("trigger_stage")      // "pre" / "mid" / "post"
  triggerArchetype String?  @map("trigger_archetype")  // "rule_executor" 等
  triggerTagsJson  String?  @map("trigger_tags_json")  // JSON array
  content          String   @db.Text                   // 话术内容（支持变量 {{customerName}} 等）
  variablesJson    String?  @map("variables_json")     // JSON array ["customerName", "archetype"]
  status           String   @default("active")         // "active" / "inactive"
  usageCount       Int      @default(0) @map("usage_count")
  // v2.0: 关联 SOP
  sopId            String?  @map("sop_id")
  sop              SopDefinition? @relation(fields: [sopId], references: [sopId])
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  usageLogs        ScriptUsageLog[]

  @@index([status, category])
  @@index([triggerStage, triggerArchetype])
  @@index([sopId])
  @@map("script_templates")
}

model ScriptUsageLog {
  id         String   @id @default(cuid())
  scriptId   String   @map("script_id")
  coachId    String   @map("coach_id")
  customerId String   @map("customer_id")
  usedAt     DateTime @default(now()) @map("used_at")

  script     ScriptTemplate @relation(fields: [scriptId], references: [id], onDelete: Cascade)

  @@index([coachId, usedAt])
  @@index([scriptId])
  @@map("script_usage_logs")
}

// --- v1.6: 跟进记录 ---
model FollowUpLog {
  id         String    @id @default(cuid())
  customerId String    @map("customer_id")
  coachId    String    @map("coach_id")
  type       String                              // "wechat" / "call" / "note"
  content    String    @db.Text
  nextAction String?   @map("next_action")       // 下一步行动
  nextDate   DateTime? @map("next_date")         // 下次跟进日期
  createdAt  DateTime  @default(now()) @map("created_at")

  customer   Customer  @relation(fields: [customerId], references: [id])

  @@index([customerId, createdAt])
  @@index([coachId, nextDate])
  @@map("follow_up_logs")
}

// --- v1.7: 埋点事件 ---
model TrackingEvent {
  id           String   @id @default(cuid())
  event        String                              // 事件名称
  sessionId    String?  @map("session_id")         // 会话ID
  inviteToken  String?  @map("invite_token")       // 邀请token（客户端）
  userId       String?  @map("user_id")            // 用户ID（助教/管理员）
  customerId   String?  @map("customer_id")        // 客户ID
  propertiesJson String? @map("properties_json")   // JSON 附加属性
  userAgent    String?  @map("user_agent")
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([event, createdAt])
  @@index([sessionId])
  @@index([inviteToken, event])
  @@index([userId, event])
  @@index([customerId, event])
  @@map("tracking_events")
}

// --- v1.7: 每日统计快照 ---
model DailyStats {
  id                  String   @id @default(cuid())
  date                DateTime @db.Date              // 统计日期
  invitesSent         Int      @default(0) @map("invites_sent")
  landingPageViews    Int      @default(0) @map("landing_page_views")
  quizStarts          Int      @default(0) @map("quiz_starts")
  quizCompletes       Int      @default(0) @map("quiz_completes")
  contactClicks       Int      @default(0) @map("contact_clicks")
  activeCoaches       Int      @default(0) @map("active_coaches")
  newCustomers        Int      @default(0) @map("new_customers")
  followUpLogs        Int      @default(0) @map("follow_up_logs")
  scriptUsages        Int      @default(0) @map("script_usages")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@unique([date])
  @@index([date])
  @@map("daily_stats")
}

// --- v1.7: 客户分层标签 ---
model CustomerSegment {
  id         String   @id @default(cuid())
  customerId String   @map("customer_id")
  segment    String                              // "high_potential" / "needs_attention" / "inactive" / "new"
  score      Int      @default(0)                // 分层得分
  reason     String?                             // 分层原因
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, segment])
  @@index([segment])
  @@index([customerId])
  @@map("customer_segments")
}

// --- v1.8: 训练计划 ---
model TrainingPlan {
  id           String   @id @default(cuid())
  name         String                              // "7天行为训练"
  description  String?  @db.Text
  durationDays Int      @map("duration_days")      // 7
  status       String   @default("active")         // "active" / "inactive"
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tasks        TrainingTask[]
  enrollments  TrainingEnrollment[]

  @@index([status])
  @@map("training_plans")
}

model TrainingTask {
  id               String   @id @default(cuid())
  planId           String   @map("plan_id")
  dayNo            Int      @map("day_no")           // 1-7
  orderNo          Int      @map("order_no")         // 任务顺序
  type             String                            // "read" / "reflect" / "action"
  title            String
  description      String   @db.Text
  contentJson      String?  @map("content_json")     // JSON 任务内容
  estimatedMinutes Int      @default(5) @map("estimated_minutes")
  createdAt        DateTime @default(now()) @map("created_at")

  plan             TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  completions      TaskCompletion[]

  @@unique([planId, dayNo, orderNo])
  @@index([planId, dayNo])
  @@map("training_tasks")
}

model TrainingEnrollment {
  id          String    @id @default(cuid())
  planId      String    @map("plan_id")
  customerId  String    @map("customer_id")
  attemptId   String?   @map("attempt_id")         // 关联的测评
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  status      String    @default("active")         // "active" / "completed" / "abandoned"
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  plan        TrainingPlan @relation(fields: [planId], references: [id])
  customer    Customer @relation(fields: [customerId], references: [id])
  completions TaskCompletion[]

  @@unique([planId, customerId])
  @@index([customerId, status])
  @@index([status, startedAt])
  @@map("training_enrollments")
}

model TaskCompletion {
  id           String   @id @default(cuid())
  enrollmentId String   @map("enrollment_id")
  taskId       String   @map("task_id")
  responseJson String?  @map("response_json")      // JSON 用户回答
  completedAt  DateTime @default(now()) @map("completed_at")

  enrollment   TrainingEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  task         TrainingTask @relation(fields: [taskId], references: [id])

  @@unique([enrollmentId, taskId])
  @@index([enrollmentId])
  @@index([taskId])
  @@map("task_completions")
}


// --- v2.2: 配置版本管理 ---
model ConfigVersion {
  id          String   @id @default(cuid())
  configType  String   @map("config_type")  // "sop" | "script" | "training"
  configId    String   @map("config_id")
  version     Int      @default(1)
  dataJson    String   @map("data_json") @db.Text
  changedBy   String   @map("changed_by")
  changeNote  String?  @map("change_note")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([configType, configId, version])
  @@index([configType, configId, createdAt])
  @@map("config_versions")
}
