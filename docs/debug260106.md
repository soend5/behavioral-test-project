# ç”Ÿäº§çº§ Debug ä¸ä»£ç å®¡æŸ¥æŠ¥å‘Šï¼ˆ260106ï¼‰

> èŒƒå›´ï¼šå…¨ä»“åº“ï¼ˆNext.js 14 App Router + TypeScript strict + Prisma/PostgreSQL + NextAuth Credentials + RBAC/é—¨ç¦å‡½æ•°ï¼‰  
> ç›®æ ‡ï¼šæ’æŸ¥â€œç”Ÿäº§çº§ bug / ç±»å‹é£é™© / æƒé™æ¼æ´â€ï¼Œä¸åšæ— è°“é‡æ„ä¸æ–°æŠ€æœ¯å¼•å…¥ã€‚

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šğŸ”´ å¿…é¡»ç«‹åˆ»ä¿®å¤ï¼ˆBlockerï¼‰

### 1) ç”Ÿäº§æœºå¯†å·²è¿›å…¥ä»“åº“ï¼ˆå®‰å…¨äº‹æ•…ï¼‰
- **ä½ç½®**
  - `.env.prod:1`ã€`.env.prod:2`ï¼ˆåŒ…å«æ•°æ®åº“è¿æ¥ä¿¡æ¯/å£ä»¤ç­‰æ•æ„Ÿæ•°æ®ï¼‰
  - `docs/DEPLOY_PROD.md:14`ã€`docs/DEPLOY_PROD.md:15`ï¼ˆåŒ…å«çœŸå®ç”Ÿäº§é¡¹ç›®æ ‡è¯†/å£ä»¤ç­‰æ•æ„Ÿä¿¡æ¯ï¼‰
- **é£é™©è¯´æ˜**
  - ä»»ä½•èƒ½è®¿é—®ä»“åº“çš„äººéƒ½å¯èƒ½ç›´æ¥è®¿é—®ç”Ÿäº§æ•°æ®åº“ï¼ˆè¶Šæƒã€æ•°æ®æ³„éœ²ã€ç ´åæ€§å†™å…¥ï¼‰ã€‚
  - å³ä½¿åç»­åˆ é™¤æ–‡ä»¶ï¼Œgit å†å²ä»å¯èƒ½ä¿ç•™æ•æ„Ÿä¿¡æ¯ã€‚
- **æ¨èä¿®æ”¹æ–¹æ¡ˆ**
  - ç«‹åˆ»ï¼š**æ—‹è½¬/é‡ç½®** Supabase æ•°æ®åº“å¯†ç ï¼ˆåŒ…å« pooler/ç›´è¿ç›¸å…³ï¼‰ã€æ£€æŸ¥è¿‘æœŸè®¿é—®æ—¥å¿—ä¸å¼‚å¸¸è¿æ¥ã€‚
  - ç«‹åˆ»ï¼šä»ä»“åº“ç§»é™¤ `.env.prod`ï¼›`DEPLOY_PROD.md` ä¸­æ‰€æœ‰çœŸå®ç”Ÿäº§ä¿¡æ¯æ”¹ä¸ºç¤ºä¾‹å ä½ç¬¦ã€‚
  - ç«‹åˆ»ï¼šæ¸…ç† git å†å²ï¼ˆrewriteï¼‰ä»¥æ¶ˆé™¤å·²æ³„éœ²çš„æœºå¯†ï¼›å¹¶åœ¨éƒ¨ç½²å¹³å°ï¼ˆVercelï¼‰ç»Ÿä¸€ç”¨ç¯å¢ƒå˜é‡ç®¡ç†ã€‚
  - è¿½åŠ ï¼šåœ¨ CI/æäº¤é’©å­å¢åŠ  secret æ‰«æï¼ˆä¾‹å¦‚æäº¤å‰æ ¡éªŒ `.env*`ã€è¿æ¥ä¸²å…³é”®å­—ï¼‰ã€‚

---

### 2) Middleware è·¯ç”±ä¿æŠ¤å­˜åœ¨æ­»å¾ªç¯ + API è¯¯æ‹¦æˆªï¼ˆç”Ÿäº§å¯ç”¨æ€§/ç™»å½•é“¾è·¯é£é™©ï¼‰
- **ä½ç½®**
  - `middleware.ts:10-13`ï¼šå¯¹æ‰€æœ‰ `/admin/*`ï¼ˆåŒ…å« `/admin/login`ï¼‰æœªåšç™½åå•ï¼Œæœªç™»å½•ä¼šé‡å®šå‘åˆ°è‡ªå·±ï¼Œå½¢æˆæ­»å¾ªç¯ã€‚
  - `middleware.ts:52-56` + `middleware.ts:30-45`ï¼šmatcher åŒ…å« `/api/:path*`ï¼Œä½†ç™½åå•åªæ”¾è¡Œ `/api/attempt*`ï¼Œä¼šæŠŠ **token-only** çš„æ¥å£ï¼ˆ`/api/quiz`ã€`/api/public/*`ï¼‰ä»¥åŠ **NextAuth** çš„ `/api/auth/*` ç½®äºâ€œå¿…é¡»ç™»å½•â€çš„ä¿æŠ¤ä¸‹ï¼Œé€ æˆä¸å¯é¢„æœŸè¡Œä¸ºï¼ˆå°¤å…¶ç”Ÿäº§ç¯å¢ƒï¼‰ã€‚
- **é£é™©è¯´æ˜**
  - admin ç™»å½•é¡µæ— æ³•ä½¿ç”¨ / æ— é™é‡å®šå‘ã€‚
  - token-only çš„ client ç«¯æ¥å£è¢«å¼ºåˆ¶è¦æ±‚ sessionï¼Œå¯¼è‡´æµ‹è¯„é“¾è·¯/é‚€è¯·è§£æä¸å¯ç”¨ã€‚
  - `/api/auth/*` è¢« middleware å½±å“ä¼šå¼•å‘â€œç”Ÿäº§æ‰è§¦å‘â€çš„è®¤è¯é—®é¢˜ï¼ˆcookie/redirect/callback è¡Œä¸ºå¼‚å¸¸ï¼‰ã€‚
- **æ¨èä¿®æ”¹æ–¹æ¡ˆï¼ˆæœ€å°æ”¹åŠ¨ï¼‰**
  - ä¿®å¤ admin ç™»å½•ç™½åå•ï¼š`/admin/login` ä¸åº”è¢«é‡å®šå‘ã€‚
  - **å»ºè®®ç§»é™¤ API matcher**ï¼šAPI æƒé™ä»¥ route å†…çš„ `requireXXX` ä¸ºå”¯ä¸€å…¥å£ï¼ˆç›®å‰ä½ ä»¬çš„è®¾è®¡å°±æ˜¯è¿™ä¹ˆå†™çš„ï¼‰ï¼Œé¿å… middleware ä¸ route çš„åŒé‡ç­–ç•¥å†²çªã€‚
  - å‚è€ƒï¼ˆç¤ºä¾‹ï¼‰ï¼š
    ```ts
    // middleware.ts
    if (path.startsWith("/admin") && path !== "/admin/login") { /* ... */ }
    export const config = { matcher: ["/admin/:path*", "/coach/:path*"] };
    ```

---

### 3) é—¨ç¦é”™è¯¯ç ä¸è·¯ç”±å±‚æ•è·ä¸ä¸€è‡´ï¼Œå¯¼è‡´â€œåº”ä¸º 404/403â€è¢«è¯¯æŠ¥ä¸º 500
- **ä½ç½®**
  - `lib/authz.ts:87`ã€`lib/authz.ts:102`ã€`lib/authz.ts:130`ã€`lib/authz.ts:145`ï¼šèµ„æºä¸å­˜åœ¨ç»Ÿä¸€æŠ› `ErrorCode.NOT_FOUND`
  - ä½†å¤šä¸ª route æ•è·åˆ†æ”¯åªå¤„ç†æ›´å…·ä½“çš„é”™è¯¯ç ï¼Œä¾‹å¦‚ï¼š
    - `app/api/coach/customers/[id]/route.ts`ï¼šæ•è· `ErrorCode.CUSTOMER_NOT_FOUND`
    - `app/api/coach/invites/[id]/expire/route.ts`ï¼šæ•è· `ErrorCode.INVITE_NOT_FOUND`
- **é£é™©è¯´æ˜**
  - çœŸå®â€œèµ„æºä¸å­˜åœ¨â€çš„å¸¸è§è·¯å¾„ä¼šè¢«è½åˆ° `INTERNAL_ERROR`ï¼Œå¯¼è‡´ 500ï¼ˆç”Ÿäº§äº‹æ•…çº§ä½“éªŒï¼‰ï¼Œä¸”ä¼šæ±¡æŸ“é”™è¯¯ç›‘æ§ä¸å‘Šè­¦ã€‚
  - è¿›ä¸€æ­¥ä¼šå½±å“å‰ç«¯é€»è¾‘ï¼ˆæŠŠå¯é¢„æœŸçš„ 404 å½“æˆç³»ç»Ÿæ•…éšœï¼‰ã€‚
- **æ¨èä¿®æ”¹æ–¹æ¡ˆ**
  - åœ¨ `lib/authz.ts` ä¸­æŒ‰èµ„æºç±»å‹æŠ›å‡ºæ›´å…·ä½“çš„é”™è¯¯ç ï¼š
    - customer ä¸å­˜åœ¨ï¼šæŠ› `ErrorCode.CUSTOMER_NOT_FOUND`
    - invite ä¸å­˜åœ¨ï¼šæŠ› `ErrorCode.INVITE_NOT_FOUND`
    - å…¶ä»–é€šç”¨ä¸å­˜åœ¨ï¼šå†ä½¿ç”¨ `ErrorCode.NOT_FOUND`
  - æˆ–ï¼ˆæ¬¡ä¼˜ï¼‰åœ¨å„ route catch é‡ŒåŒæ—¶å…¼å®¹ `NOT_FOUND`ï¼Œä½†ä¼šç»§ç»­æ”¾å¤§â€œé”™è¯¯ç è¯­ä¹‰æ¼‚ç§»â€ã€‚

---

### 4) æµ‹è¯„ç­”é¢˜/æäº¤æœªç»‘å®šå½“å‰ invite çš„é¢˜åº“ï¼ˆæ•°æ®æ­£ç¡®æ€§/è¶Šæƒå†™å…¥ï¼‰
- **ä½ç½®**
  - `app/api/attempt/answer/route.ts:55-97`ï¼šä»…æ ¡éªŒ question/option å­˜åœ¨ä¸å…³è”åŒ¹é…ï¼Œ**æœªæ ¡éªŒå±äº invite æŒ‡å®šçš„ quizVersion+version**
  - `app/api/attempt/submit/route.ts:74-85`ï¼šæ ¹æ® answers çš„ optionIds æ‹‰å– options å¹¶è¯„åˆ†ï¼Œ**æœªæ ¡éªŒè¿™äº› options å±äº invite çš„é¢˜åº“**
- **é£é™©è¯´æ˜**
  - æ‹¿åˆ°æœ‰æ•ˆ token çš„å®¢æˆ·ç«¯å¯ä»¥æäº¤â€œå…¶ä»–é¢˜åº“â€çš„ optionId æ¥å½±å“è¯„åˆ†/æ ‡ç­¾ï¼Œå¯¼è‡´ç»“æœæ±¡æŸ“ï¼ˆåœ¨ä¸šåŠ¡ä¸Šç­‰åŒäºç¯¡æ”¹æµ‹è¯„ç»“æœï¼‰ã€‚
  - åç»­å¦‚æœä½ ä»¬å¼•å…¥ SOP åŒ¹é…/ç”»åƒç­–ç•¥ï¼Œä¼šæ”¾å¤§å½±å“ï¼ˆé”™è¯¯åˆ†æµ/é”™è¯¯å»ºè®®ï¼‰ã€‚
- **æ¨èä¿®æ”¹æ–¹æ¡ˆ**
  - åœ¨ answer/submit ä¸­éƒ½åŠ å…¥â€œé¢˜åº“å½’å±æ ¡éªŒâ€ï¼š
    1) å…ˆç”¨ invite é”å®šå”¯ä¸€ quizï¼ˆå»ºè®® `(quizVersion, version)` å”¯ä¸€åŒ–åç”¨ `findUnique`ï¼‰
    2) æ ¡éªŒä¼ å…¥çš„ questionId/optionId å…¨éƒ¨å±äºè¯¥ quizï¼ˆå¯é€šè¿‡ join æˆ–äºŒæ¬¡æŸ¥è¯¢æ ¡éªŒï¼‰ã€‚
  - é¢å¤–å»ºè®®ï¼šå¯¹ `version` åšä¸¥æ ¼æšä¸¾æ ¡éªŒï¼ˆ`fast | pro`ï¼‰ï¼Œé¿å… `attempt.version as "fast" | "pro"` æ©ç›–è„æ•°æ®ã€‚

---

### 5) ç”Ÿäº§ seed å­˜åœ¨é»˜è®¤å¼±å£ä»¤è½åº“åˆ†æ”¯ï¼ˆé«˜å±ï¼‰
- **ä½ç½®**
  - `prisma/seed.prod.ts:31`ã€`prisma/seed.prod.ts:55`ï¼šå½“æœªè®¾ç½®ç¯å¢ƒå˜é‡æ—¶å›é€€åˆ°é»˜è®¤å£ä»¤ï¼ˆ`admin123/coach123`ï¼‰
- **é£é™©è¯´æ˜**
  - ä»»ä½•ä¸€æ¬¡â€œè¯¯è·‘ seed:prodâ€éƒ½ä¼šåœ¨ç”Ÿäº§åˆ›å»ºå¼±å£ä»¤è´¦å·ï¼Œç›´æ¥æ²¦é™·ã€‚
- **æ¨èä¿®æ”¹æ–¹æ¡ˆ**
  - `seed.prod.ts` æ”¹ä¸ºï¼šç¼ºå°‘ `ADMIN_PASSWORD/COACH_PASSWORD` æ—¶ç›´æ¥ `throw` é€€å‡ºï¼ˆç”Ÿäº§ä¸å…è®¸é»˜è®¤å€¼ï¼‰ã€‚
  - éƒ¨ç½²æ–‡æ¡£ä¸­å¼ºè°ƒâ€œç”Ÿäº§ç¯å¢ƒå¿…é¡»æ˜¾å¼è®¾ç½®å¼ºå¯†ç â€ï¼Œå¹¶åœ¨è¿è¡Œè„šæœ¬å‰åšæ ¡éªŒã€‚

---

### 6) è¿ç§»ç­–ç•¥ä¸éƒ¨ç½²å‘½ä»¤è‡ªç›¸çŸ›ç›¾ï¼ˆç”Ÿäº§ç¨³å®šæ€§/å¯å®¡è®¡æ€§é£é™©ï¼‰
- **ä½ç½®**
  - `.gitignore:39`ï¼šå¿½ç•¥ `prisma/migrations`
  - `vercel.json:2`ï¼šbuild é˜¶æ®µæ‰§è¡Œ `prisma migrate deploy`
  - `prisma/schema.prisma:8-12`ï¼šä½¿ç”¨ `DATABASE_URL` + `DIRECT_URL` åŒºåˆ†è¿è¡Œä¸è¿ç§»
- **é£é™©è¯´æ˜**
  - è¿ç§»æ–‡ä»¶ä¸è¿›ä»“åº“å°†å¯¼è‡´ `migrate deploy` åœ¨æ–°ç¯å¢ƒ/å›æ»š/ç¾å¤‡æ—¶ä¸å¯é‡æ”¾ï¼›ç”Ÿäº§â€œçŠ¶æ€æ¼‚ç§»â€æ— æ³•å®¡è®¡ã€‚
  - `DIRECT_URL` æœªåœ¨ `.env.prod` ä¸­ä½“ç°ï¼ˆä»…çœ‹åˆ° `DATABASE_URL/DIRECT_URL` éƒ½æŒ‡å‘ poolerï¼‰ï¼Œè¿ç§»/seed å¯èƒ½å— pgbouncer å½±å“äº§ç”Ÿå¤±è´¥æˆ–éšæ€§é—®é¢˜ã€‚
- **æ¨èä¿®æ”¹æ–¹æ¡ˆ**
  - è¿ç§»æ–‡ä»¶å¿…é¡»çº³å…¥ç‰ˆæœ¬æ§åˆ¶ï¼ˆç§»é™¤ `.gitignore` å¯¹ migrations çš„å¿½ç•¥ï¼Œæˆ–æ˜¾å¼åªå¿½ç•¥æœ¬åœ°ç”Ÿæˆçš„æ— å…³æ–‡ä»¶ï¼‰ã€‚
  - ç”Ÿäº§ï¼š`DATABASE_URL` ä½¿ç”¨ poolerï¼›`DIRECT_URL` ä½¿ç”¨ç›´è¿ï¼ˆç”¨äº migrate/seedï¼‰ã€‚
  - å°†â€œè¿ç§»æ‰§è¡Œç­–ç•¥â€å†™è¿›å›¢é˜Ÿè§„èŒƒï¼ˆä½•æ—¶ç”Ÿæˆè¿ç§»ã€ä½•æ—¶ deployã€å¦‚ä½•å›æ»š/å®¡è®¡ï¼‰ã€‚

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šğŸŸ  å¼ºçƒˆå»ºè®®ä¿®å¤ï¼ˆHighï¼‰

### 1) Prisma çº¦æŸç¼ºå¤±ï¼Œ`findFirst` è¯­ä¹‰ä¸ç¨³å®šï¼ˆè§„æ¨¡åŒ–åå¿…å‡ºæ•°æ®é—®é¢˜ï¼‰
- **ç°çŠ¶**
  - ä¾‹å¦‚ `app/api/quiz/route.ts` é€šè¿‡ `quizVersion + version` æŸ¥ quizï¼Œä½† schema æœªå£°æ˜å”¯ä¸€çº¦æŸï¼›ä¸€æ—¦å‡ºç°é‡å¤è¡Œï¼Œ`findFirst` å°†éšæœºå‘½ä¸­ã€‚
  - `Question.orderNo`ã€`Option.orderNo` ç­‰ä¹Ÿç¼ºå°‘â€œåŒçˆ¶çº§å†…å”¯ä¸€â€çš„çº¦æŸï¼Œå®¹æ˜“äº§ç”Ÿä¸å¯é¢„æœŸæ’åº/é‡å¤ã€‚
- **å»ºè®®**
  - è¡¥é½å¤åˆå”¯ä¸€çº¦æŸ/ç´¢å¼•ï¼ˆç¤ºä¾‹ï¼š`Quiz(quizVersion, version)`ã€`Question(quizId, orderNo)`ã€`Option(questionId, orderNo)`ã€`CoachTag(customerId, coachId, tagKey)`ã€`SopStageMap(sopId, stageId)` ç­‰ï¼‰ã€‚
  - çº¦æŸè¡¥é½åï¼Œå°†ç›¸å…³æŸ¥è¯¢æ”¹ä¸º `findUnique`ï¼ŒæŠŠâ€œæ•°æ®å”¯ä¸€æ€§å‡è®¾â€å›ºåŒ–åˆ°æ•°æ®åº“å±‚ã€‚

### 2) å¤šæ­¥å†™å…¥ç¼ºå°‘äº‹åŠ¡ï¼Œå­˜åœ¨å¹¶å‘ç«æ€ä¸çŠ¶æ€ä¸ä¸€è‡´
- **ä½ç½®ç¤ºä¾‹**
  - `app/api/attempt/start/route.ts`ï¼šå…ˆæŸ¥å†å†™ï¼ˆå¹¶å‘ä¸‹å¯èƒ½åˆ›å»ºå¤šä¸ªæœªæäº¤ attemptï¼‰
  - `app/api/attempt/submit/route.ts`ï¼šæ›´æ–° attempt ä¸ invite ä¸ºä¸¤æ¬¡å†™å…¥ï¼Œä¸­é€”å¤±è´¥ä¼šç•™ä¸‹ä¸ä¸€è‡´çŠ¶æ€
- **å»ºè®®**
  - ä½¿ç”¨ `prisma.$transaction` åˆå¹¶å…³é”®å†™å…¥ã€‚
  - å¯¹â€œåŒ invite ä»…å…è®¸ 1 ä¸ªæœªæäº¤ attemptâ€ç­‰å…³é”®ä¸å˜é‡ï¼Œå»ºè®®åœ¨æ•°æ®åº“å±‚åŠ çº¦æŸï¼ˆPostgres å¯ç”¨éƒ¨åˆ†å”¯ä¸€ç´¢å¼•ï¼‰ï¼Œå¹¶åœ¨ä»£ç é‡Œæ•è·å”¯ä¸€å†²çªåšå¹‚ç­‰è¿”å›ã€‚

### 3) NextAuth session å†…å®¹ä¸ç±»å‹å£°æ˜ä¸ä¸€è‡´ï¼ˆéšè—å‹ç”Ÿäº§ bugï¼‰
- **ä½ç½®**
  - ç±»å‹å£°æ˜ï¼š`types/next-auth.d.ts:4-9` è¦æ±‚ `session.user.username` å¿…å­˜åœ¨
  - å®é™…å›å¡«ï¼š`app/api/auth/[...nextauth]/route.ts:52-56` åªå›å¡« `id/role`ï¼ˆ`username` æœªå›å¡«ï¼‰
- **é£é™©**
  - ä¾èµ– `session.user.username` çš„æ¥å£/é¡µé¢å¯èƒ½åœ¨ç”Ÿäº§å‡ºç° `undefined`ï¼Œå¹¶ä¸” TypeScript ä¸ä¼šæŠ¥è­¦ã€‚
- **å»ºè®®**
  - jwt/session callback åŒæ­¥å†™å…¥ `username`ï¼Œå¹¶æ‰©å±• `next-auth/jwt` çš„å£°æ˜åŒ…å« `username`ã€‚
  - å¯¹ `NEXTAUTH_SECRET` ç¼ºå¤±åš fail-fast æ ¡éªŒï¼ˆç”Ÿäº§å¿…é¡»é…ç½®ï¼‰ã€‚

### 4) JSON å­—ç¬¦ä¸²è§£æç¼ºå°‘ç»Ÿä¸€å…œåº•ï¼Œè„æ•°æ®ä¼šç›´æ¥ 500
- **ä½ç½®**
  - `lib/sop-matcher.ts` å¤šå¤„ `JSON.parse()` æ—  try/catch
- **å»ºè®®**
  - æŠ½ `safeJsonParseArray/safeJsonParseObject`ï¼Œè§£æå¤±è´¥é™çº§ä¸º `[]/{}`ï¼›å¹¶è€ƒè™‘åœ¨å†™å…¥æ—¶åšæ ¼å¼æ ¡éªŒï¼Œå‡å°‘è„æ•°æ®è¿›å…¥åº“ã€‚

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šğŸŸ¡ å¯æ¥å—ä½†ä¸ä¼˜é›…ï¼ˆMediumï¼‰

### 1) TypeScript `any` æ‰©æ•£ï¼Œæ¥å£å¥‘çº¦ä¸æ”¶æ•›
- **ä½ç½®ç¤ºä¾‹**
  - `lib/apiResponse.ts:12`ï¼ˆ`data: any`ï¼‰
  - å¤šä¸ª routeï¼š`catch (error: any)`ã€`where: any`ã€`answers.map((a: any) => ...)`
- **å»ºè®®**
  - å·²å¼•å…¥ `zod`ï¼Œå»ºè®®ä¼˜å…ˆåœ¨â€œæƒé™/æµ‹è¯„æ•°æ®é“¾è·¯â€ä¸Šåš request/query çš„ schema æ ¡éªŒå¹¶äº§å‡ºæ”¶æ•›ç±»å‹ï¼ˆå¯æ’æœŸåˆ° V1.1ï¼‰ã€‚

### 2) é‡å¤/é—ç•™æ¨¡å—ä¼šè¯¯å¯¼ç»´æŠ¤è€…ï¼ˆç»“æ„å€ºï¼‰
- **ç°çŠ¶**
  - `lib/apiResponse.ts` ä¸ `lib/api-response.ts` å¹¶å­˜ï¼ˆå®é™…å¤šç”¨å‰è€…ï¼‰
  - `lib/rbac.ts`ã€`lib/auth-helpers.ts`ã€`lib/auth.ts`ï¼ˆå ä½/æœªä½¿ç”¨/ä¸ç°è¡Œ `authz` å†²çªï¼‰
- **å»ºè®®**
  - ç»Ÿä¸€å…¥å£ï¼ˆåªä¿ç•™ `authz + apiResponse + errors` è¿™ä¸€å¥—ï¼‰ï¼Œåˆ é™¤æˆ–æ˜ç¡®å¼ƒç”¨æ—§æ–‡ä»¶ï¼Œé¿å…æ–°äººè°ƒç”¨é”™é—¨ç¦/é”™è¯¯ç ã€‚

### 3) åˆ†é¡µ/ç­›é€‰çš„è¯­ä¹‰ä¸€è‡´æ€§é—®é¢˜
- **ç¤ºä¾‹**
  - `app/api/coach/customers/route.ts`ï¼š`total` è¿”å›çš„æ˜¯å®¢æˆ·ç«¯è¿‡æ»¤åçš„é•¿åº¦ï¼Œä¸æ˜¯æ•°æ®åº“å…¨é‡è®¡æ•°ï¼›åœ¨åç»­è§„æ¨¡åŒ–ä¸ UI åˆ†é¡µä¸Šå®¹æ˜“è¸©å‘ã€‚
- **å»ºè®®**
  - å°†ç­›é€‰å°½é‡ä¸‹æ¨åˆ°æ•°æ®åº“ï¼›`total` è¿”å›åº”ä¸åˆ†é¡µå£å¾„ä¸€è‡´ã€‚

---

## ç¬¬å››éƒ¨åˆ†ï¼šğŸŸ¢ è®¾è®¡è¯„ä»·ï¼ˆè¯šå®ç‰ˆï¼‰

### è®¾è®¡æ­£ç¡®çš„ç‚¹
- **é—¨ç¦é›†ä¸­åŒ–æ–¹å‘æ­£ç¡®**ï¼š`lib/authz.ts` æŠŠ RBAC/ownership/token æ ¡éªŒé›†ä¸­ï¼Œæ˜¯å¯ç»´æŠ¤ä¸”å¯å®¡è®¡çš„åšæ³•ã€‚
- **token æ˜æ–‡ä¸è½åº“**ï¼š`lib/token.ts` + `Invite.tokenHash @unique` æ˜¯ç”Ÿäº§çº§å®‰å…¨åŸºçº¿ã€‚
- **ç»Ÿä¸€å“åº”ç»“æ„**ï¼š`lib/apiResponse.ts` + `lib/errors.ts` èƒ½æŠŠé”™è¯¯ç ä¸ HTTP çŠ¶æ€ç»Ÿä¸€æ”¶å£ï¼Œä¾¿äºå‰åç«¯åä½œä¸ç›‘æ§å½’å› ã€‚

### å·¥ç¨‹æ„è¯†ä½“ç°
- attempt/startã€submit çš„å¹‚ç­‰åˆ†æ”¯æ€»ä½“æ–¹å‘å¯¹ï¼ˆå¯¹å¼±ç½‘/é‡è¯•å‹å¥½ï¼‰ï¼Œä½†å»ºè®®è¿›ä¸€æ­¥ç”¨äº‹åŠ¡/DB çº¦æŸè¡¥ä¸Šå¹¶å‘ç«æ€çš„çŸ­æ¿ã€‚

### â€œåƒ AI ç”Ÿæˆä½†è¢«æ­£ç¡®çº¦æŸâ€çš„åœ°æ–¹
- å¤§é‡â€œæ ¡éªŒç‚¹æ¸…å•å¼æ³¨é‡Šâ€å¾ˆåƒç”Ÿæˆå¼äº§ç‰©ï¼›å¥½å¤„æ˜¯æ€è·¯æ¸…æ™°ï¼Œåå¤„æ˜¯é—ç•™æ–‡ä»¶/é‡å¤æ¨¡å—ä¸ `any` æ‰©æ•£è¯´æ˜çº¦æŸè¿˜æ²¡å½»åº•è½åœ°ï¼Œéœ€è¦ä¸€æ¬¡â€œåˆ å†—ä½™ + æ”¶æ•›å¥‘çº¦ + å›ºåŒ– DB çº¦æŸâ€çš„å·¥ç¨‹æ²»ç†ã€‚

---

## é™„ï¼šä¸ç°æœ‰è§„èŒƒæ–‡æ¡£çš„å¯¹é½æé†’
- é—¨ç¦æµ‹è¯•ç”¨ä¾‹å¯å‚è€ƒï¼š`docs/SMOKE_TEST_AUTHZ.md`
- RBAC è§„èŒƒå¯å‚è€ƒï¼š`docs/RBAC_SPEC.md`
- coach ç«¯æ¥å£å®ç°è¯´æ˜ï¼š`docs/COACH_API_IMPLEMENTATION.md`

---

## ä¿®å¤è®¡åˆ’ä¸æ‰§è¡Œè®°å½•ï¼ˆ260106ï¼‰

### ä¿®å¤è®¡åˆ’ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

**P0 / ç«‹å³å¤„ç†ï¼ˆæœ¬æ¬¡å·²æ‰§è¡Œï¼‰**
1. æ¸…ç†ä»“åº“å†…ç”Ÿäº§æœºå¯†ï¼ˆåˆ é™¤æ˜æ–‡ envã€è„±æ•éƒ¨ç½²æ–‡æ¡£ã€å®Œå–„å¿½ç•¥è§„åˆ™ï¼‰
2. ä¿®å¤ middlewareï¼ˆadmin ç™»å½•æ­»å¾ªç¯ã€é¿å… API è¢« middleware è¯¯æ‹¦æˆªï¼‰
3. ä¿®å¤é—¨ç¦é”™è¯¯ç è¯­ä¹‰ï¼ˆé¿å… 404 è¢«è¯¯æŠ¥ä¸º 500ï¼‰
4. åŠ å¼ºæµ‹è¯„é“¾è·¯çš„æ•°æ®ä¸€è‡´æ€§ï¼ˆanswer/submit ç»‘å®š invite å¯¹åº”é¢˜åº“ï¼‰
5. åŠ å›ºç”Ÿäº§ seedï¼ˆç¦æ­¢é»˜è®¤å¼±å£ä»¤è½åº“ï¼‰
6. ä¿®å¤ NextAuth session å†…å®¹ä¸ç±»å‹å£°æ˜ä¸ä¸€è‡´
7. ä¿®å¤ lint å¯ç”¨æ€§ï¼ˆé¿å… `next lint` é¦–æ¬¡è¿è¡Œäº¤äº’å¼é…ç½®ï¼‰

**P1 / å¼ºçƒˆå»ºè®®å°½å¿«æ’æœŸï¼ˆæœ¬æ¬¡æœªæ‰§è¡Œï¼Œé¿å…ç›´æ¥å½±å“ç”Ÿäº§è¿ç§»ï¼‰**
1. Prisma schema è¡¥é½å”¯ä¸€çº¦æŸä¸ç´¢å¼•ï¼ˆQuiz/Question/Option/CoachTag/SopStageMap ç­‰ï¼‰ï¼Œå¹¶é…å¥—è¿ç§»ä¸æ•°æ®æ¸…ç†é¢„æ¡ˆ
2. attempt/startã€submit ç­‰å…³é”®å†™å…¥ä½¿ç”¨äº‹åŠ¡ +ï¼ˆå¿…è¦æ—¶ï¼‰DB çº¦æŸé˜²å¹¶å‘é‡å¤
3. SOP/è¯„åˆ† JSON å­—æ®µç»Ÿä¸€ safe-parseï¼ˆè§£æå¤±è´¥é™çº§ + å†™å…¥æ—¶æ ¡éªŒï¼‰
4. å°† request æ ¡éªŒé€æ­¥æ”¶æ•›åˆ° zodï¼ˆä¼˜å…ˆè¦†ç›– token/attempt/æƒé™ç›¸å…³æ¥å£ï¼‰

### å·²æ‰§è¡Œä¿®å¤ï¼ˆè½åœ°å˜æ›´æ¸…å•ï¼‰

**å®‰å…¨ / é…ç½®**
- åˆ é™¤äº†ä»“åº“ä¸­çš„ `.env.prod`ï¼ˆé¿å…ç”Ÿäº§è¿æ¥ä¿¡æ¯ç»§ç»­æ³„éœ²ï¼‰
- `docs/DEPLOY_PROD.md` å·²è„±æ•ï¼ˆç§»é™¤çœŸå®ç”Ÿäº§ Project URL/Password/Hostï¼‰
- `.gitignore` æ›´æ–°ä¸ºå¿½ç•¥ `.env*`ï¼ˆä¿ç•™ `!.env.example`ï¼‰ï¼Œé¿å…å†æ¬¡è¯¯æäº¤
- `.gitignore` ç§»é™¤å¯¹ `prisma/migrations` çš„å¿½ç•¥ï¼ˆè¿ç§»æ–‡ä»¶å¿…é¡»çº³å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œé…åˆ `migrate deploy`ï¼‰

**æƒé™ / é—¨ç¦ / è®¤è¯**
- `middleware.ts`ï¼š
  - ä¿®å¤ `/admin/login` é‡å®šå‘æ­»å¾ªç¯
  - å»æ‰ `/api/:path*` çš„ matcherï¼Œé¿å… middleware ä¸ route å†…é—¨ç¦ç­–ç•¥å†²çª
  - `authorized` æ”¹ä¸ºæ€»æ˜¯æ”¾è¡Œï¼Œè®©â€œæŒ‰è·¯å¾„/è§’è‰²é‡å®šå‘â€é€»è¾‘åœ¨è‡ªå®šä¹‰ middleware å†…ç”Ÿæ•ˆ
- `lib/authz.ts`ï¼š
  - customer ä¸å­˜åœ¨æŠ› `ErrorCode.CUSTOMER_NOT_FOUND`
  - invite ä¸å­˜åœ¨æŠ› `ErrorCode.INVITE_NOT_FOUND`
- `app/api/auth/[...nextauth]/route.ts` + `types/next-auth.d.ts`ï¼š
  - jwt/session å›è°ƒè¡¥é½ `username`ï¼Œæ¶ˆé™¤ç±»å‹å£°æ˜ä¸å®é™… session ä¸ä¸€è‡´

**æ•°æ®æ­£ç¡®æ€§ï¼ˆæµ‹è¯„é“¾è·¯ï¼‰**
- `app/api/attempt/answer/route.ts`ï¼šæäº¤ç­”æ¡ˆå‰å¼ºåˆ¶ç»‘å®š invite å¯¹åº”çš„ quizï¼ˆé˜²æ­¢è·¨é¢˜åº“æäº¤å¯¼è‡´ç»“æœæ±¡æŸ“ï¼‰
- `app/api/attempt/submit/route.ts`ï¼šæäº¤æ—¶æ ¡éªŒ option å¿…é¡»å±äº invite å¯¹åº” quizï¼›å¹¶å¯¹ attempt.version åšåˆæ³•æ€§æ ¡éªŒ
- `app/api/coach/invites/route.ts`ï¼šå¯¹ `version` åšæšä¸¾æ ¡éªŒï¼ˆfast/proï¼‰ï¼Œå¹¶æ ¡éªŒ `expiresAt` æ ¼å¼ï¼›é‚€è¯· URL ä½¿ç”¨ `request.nextUrl.origin` ä½œä¸ºå…œåº•

**æ„å»ºç¨³å®šæ€§**
- `app/api/admin/audit/route.ts`ã€`app/api/public/attempt/result/route.ts`ã€`app/api/quiz/route.ts`ï¼šæ˜¾å¼ `export const dynamic = "force-dynamic"`ï¼Œé¿å… `next build` æœŸé—´å‡ºç° â€œDynamic server usageâ€ çš„è¯¯å¯¼æ€§é”™è¯¯æ—¥å¿—

**å·¥å…·é“¾**
- æ–°å¢ `.eslintrc.json`ï¼Œä½¿ `npm run lint` ä¸å†è§¦å‘äº¤äº’å¼åˆå§‹åŒ–

### éœ€è¦äººå·¥/è¿ç»´åŠ¨ä½œï¼ˆä»ç„¶å¿…é¡»åšï¼‰

1. **ç«‹å³æ—‹è½¬ç”Ÿäº§å‡­è¯**ï¼ˆSupabase æ•°æ®åº“å¯†ç /è¿æ¥ä¸²ç›¸å…³å¯†é’¥ã€Vercel ç¯å¢ƒå˜é‡ï¼‰ï¼šä»“åº“æ›¾åŒ…å«æ˜æ–‡ä¿¡æ¯ï¼Œå¿…é¡»è§†ä¸ºå·²æ³„éœ²ã€‚
2. **æ¸…ç† git å†å²**ï¼šä»…åˆ é™¤æ–‡ä»¶ä¸è¶³ä»¥æ¶ˆé™¤å†å²æ³„éœ²ï¼ˆéœ€è¦ rewrite å†å²å¹¶å¼ºåˆ¶æ¨é€ï¼‰ã€‚
3. **æ ¸å¯¹ç”Ÿäº§ç¯å¢ƒå˜é‡**ï¼šç¡®ä¿ `NEXTAUTH_SECRET`ã€`NEXTAUTH_URL`ã€`DATABASE_URL`ã€`DIRECT_URL` éƒ½æŒ‰ç”Ÿäº§ç­–ç•¥è®¾ç½®ï¼ˆmigrate/seed ä½¿ç”¨ç›´è¿ï¼‰ã€‚

### éªŒè¯ç»“æœ

- `npm run lint`ï¼šé€šè¿‡ï¼ˆæ— è­¦å‘Š/é”™è¯¯ï¼‰
- `npm run build`ï¼šé€šè¿‡ï¼ˆæ—  â€œDynamic server usageâ€ è¯¯æŠ¥æ—¥å¿—ï¼‰

---

## 260106 è¡¥å……ï¼šP1 å·²æ‰§è¡Œ + æœ¬æ¬¡ä¿®å¤å‰ææ›´æ–°

### é¡¹ç›®æ–¹åé¦ˆï¼ˆå½±å“æœ¬æ¬¡ä¿®å¤ç­–ç•¥ï¼‰

1. GitHub ä»“åº“ä¸ºç§å¯†ä»“åº“ï¼Œæ— æ³„éœ²é£é™©ã€‚
2. å¯¹ P1 ä»»åŠ¡å¯ç«‹å³å®‰æ’ä¿®å¤ã€‚
3. é¡¹ç›®ç°é˜¶æ®µä»å¤„äºåŠŸèƒ½å¼€å‘ä¸æµ‹è¯•é˜¶æ®µï¼›éƒ¨ç½² GitHub ä»£ç ä»“åº“ä¸ Vercel ä¸»è¦ä¸ºå†…éƒ¨æµ‹è¯•æ–¹ä¾¿ï¼›ç›®å‰å†…éƒ¨ç°åº¦æµ‹è¯•ï¼Œä¸æ¶‰åŠå¤§èŒƒå›´ä¸Šçº¿æœåŠ¡ï¼Œå¯æ¥å—è¾ƒå¤§æ”¹åŠ¨ã€‚

> å¤‡æ³¨ï¼šå³ä¾¿ç§å¯†ä»“åº“æ³„éœ²æ¦‚ç‡ä½ï¼Œå†å²ä¸Šå‡ºç°è¿‡ `.env.prod` æ˜æ–‡å‡­è¯è½åº“/è½æ–‡æ¡£çš„æƒ…å†µï¼Œä»å»ºè®®æŒ‰â€œè§†ä¸ºå·²æ³„éœ²â€çš„æ ‡å‡†å®Œæˆä¸€æ¬¡å‡­è¯è½®æ¢ä¸æƒé™æ ¸å¯¹ï¼ˆå¯åœ¨å†…éƒ¨çª—å£æœŸå®Œæˆï¼‰ã€‚

### P1 è½åœ°ï¼ˆæœ¬æ¬¡å·²å®Œæˆï¼‰

**Prisma çº¦æŸä¸è¿ç§»**
- `prisma/schema.prisma`ï¼šè¡¥é½å…³é”®å”¯ä¸€çº¦æŸ/ç´¢å¼•ï¼ˆQuiz/Question/Option/CoachTag/SopStageMap ç­‰ï¼‰ã€‚
- `prisma/migrations/20260106090000_hardening_constraints/migration.sql`ï¼šæ–°å¢å”¯ä¸€ç´¢å¼• + éƒ¨åˆ†å”¯ä¸€ç´¢å¼•ï¼ˆæœªæäº¤ attemptã€é»˜è®¤ SOPï¼‰ä¸å¸¸ç”¨æŸ¥è¯¢ç´¢å¼•ã€‚
- è¯´æ˜ï¼šè¿ç§»éœ€è¦åœ¨ç›®æ ‡ç¯å¢ƒæ‰§è¡Œ `prisma migrate deploy` æ‰ä¼šç”Ÿæ•ˆï¼›è‹¥çº¿ä¸Šå·²æœ‰è„æ•°æ®ï¼ˆé‡å¤ orderNo/é‡å¤é»˜è®¤ SOP/é‡å¤æœªæäº¤ attemptï¼‰ï¼Œè¿ç§»ä¼šå¤±è´¥ï¼Œéœ€å…ˆæ¸…ç†æ•°æ®ã€‚

**å¹¶å‘/å¹‚ç­‰ï¼šattempt é“¾è·¯**
- `app/api/attempt/start/route.ts`ï¼šè¯·æ±‚ä½“éæ³• JSON ç»Ÿä¸€è¿”å› 400ï¼›attempt åˆ›å»ºä¸ invite çŠ¶æ€æ›´æ–°å°è£…è¿›äº‹åŠ¡ï¼Œå¹¶å¤„ç†å¹¶å‘ä¸‹çš„å”¯ä¸€å†²çªå…œåº•ã€‚
- `app/api/attempt/answer/route.ts`ï¼šè¯·æ±‚ä½“éæ³• JSON ç»Ÿä¸€è¿”å› 400ï¼›æ”¶æ•› token/attemptId çš„ç±»å‹ï¼Œé¿å… unknown ç›´ä¼ é—¨ç¦å‡½æ•°ã€‚
- `app/api/attempt/submit/route.ts`ï¼šå¼•å…¥ zod æ ¡éªŒ + äº‹åŠ¡ï¼›ä½¿ç”¨ `updateMany(where: submittedAt=null)` é”å®šæäº¤ï¼Œé¿å…å¹¶å‘é‡å¤æäº¤ä¸â€œç­”é¢˜/æäº¤â€ç«æ€ï¼›å¹¶å¼ºåŒ– quiz/option å½’å±æ ¡éªŒä¸è¿”å›å­—æ®µä¸€è‡´æ€§ã€‚
- `lib/authz.ts`ã€`lib/audit.ts`ï¼šé—¨ç¦ä¸å®¡è®¡å‡½æ•°æ”¯æŒ `Prisma.TransactionClient`ï¼Œä¾¿äº route åœ¨äº‹åŠ¡å†…å¤ç”¨ä¸€è‡´çš„é—¨ç¦é€»è¾‘ã€‚

**JSON å­—æ®µ safe-parseï¼ˆè§£æå¤±è´¥é™çº§ï¼Œé¿å… 500ï¼‰**
- æ–°å¢ `lib/json.ts`ï¼š`safeJsonParse` / `safeJsonParseWithSchema`ã€‚
- `lib/sop-matcher.ts`ï¼šSOP rule/definition/stage çš„ JSON å­—æ®µç»Ÿä¸€ safe-parseã€‚
- `app/api/public/attempt/result/route.ts`ã€`app/api/admin/audit/route.ts`ã€`app/api/coach/customers/[id]/route.ts`ã€`app/api/admin/options/*`ã€`app/api/admin/sop/*`ï¼šè¯»å– JSON å­—æ®µæ”¹ä¸º safe-parseï¼Œé™ä½è„æ•°æ®å¯¼è‡´çš„çº¿ä¸Š 500 é£é™©ã€‚

### æœ¬æ¬¡éªŒè¯ï¼ˆæ›´æ–°ï¼‰

- `npm run db:generate`ï¼šé€šè¿‡
- `npm run lint`ï¼šé€šè¿‡ï¼ˆæ— è­¦å‘Š/é”™è¯¯ï¼‰
- `npm run build`ï¼šé€šè¿‡ï¼ˆWindows ä¸‹å¦‚é‡ `.next` æ¸…ç†æŠ¥ `readlink EINVAL`ï¼Œåˆ é™¤ `.next` åé‡è·‘å³å¯ï¼‰
