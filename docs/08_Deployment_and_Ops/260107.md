# 260107：DB Deploy 工程化落地（migrate + seed + smoke gate）

目标：让**数据库发布**（Prisma migrate + seed）跟随 main 版本更新，但**与 Vercel 应用发布解耦**，并且具备：
- seed:prod 强门禁（防本地误连生产库）
- 防并发锁（避免重复触发/并发写库）
- GitHub Actions 数据库发布流水线（仅 main）
- 可脚本化只读验收（smoke gate）

---

## 1) 变更文件清单

本轮新增/修改：
- `package.json`（补齐 CI scripts：`db:migrate:deploy`、`smoke:prod-gate`）
- `vercel.json`（移除 build 阶段 migrate/seed，改为仅 build）
- `README.md`（更新：Vercel 只 build；migrate/seed 走 DB Deploy；seed:prod 新门禁变量）
- `.github/workflows/db-deploy.yml`（数据库发布流水线）
- `prisma/seed.prod.ts`（生产 seed：强门禁 + advisory lock + 幂等导入）
- `prisma/seed-content.ts`（支持 transaction client，便于 seed:prod 包在单事务里执行）
- `scripts/smoke-prod-gate.ts`（只读验收脚本：migrations/seed/read-only guard）
- `docs/08_Deployment_and_Ops/GITHUB_ENV_PRODUCTION.md`（GitHub Environments: production 配置说明）
- `docs/08_Deployment_and_Ops/DEPLOY_PROD.md`（更新：与 Vercel 解耦后的生产部署说明）

---

## 2) Workflow 完整内容（DB Deploy）

文件：`.github/workflows/db-deploy.yml`

```yml
name: DB Deploy (migrate + seed)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

concurrency:
  group: db-deploy-main
  cancel-in-progress: false

jobs:
  db:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Validate content (data/seed/*.json)
        run: npm run content:validate

      - name: Prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL:   ${{ secrets.DIRECT_URL }}
        run: npm run db:migrate:deploy

      - name: Seed prod (idempotent + gates + advisory lock)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL:   ${{ secrets.DIRECT_URL }}
          SEED_ADMIN_PASSWORD: ${{ secrets.SEED_ADMIN_PASSWORD }}
        run: npm run seed:prod

      - name: Smoke gate (read-only)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL:   ${{ secrets.DIRECT_URL }}
        run: npm run smoke:prod-gate
```

说明：
- 这是**数据库发布流水线**；Vercel 只负责应用发布，不在 Vercel Build 阶段执行 migrate/seed。
- concurrency 已开启，避免 main 上并发写库。

---

## 3) seed:prod 门禁 + advisory lock 说明

文件：`prisma/seed.prod.ts`

### 3.1 强门禁（必须真的阻止执行）
- 环境门禁：仅允许在以下场景运行，否则 `exit(1)`：
  - `GITHUB_ACTIONS=true`（CI）
  - 或显式 `ALLOW_PROD_SEED=true`
- 强密码门禁：
  - 必须提供 `SEED_ADMIN_PASSWORD`
  - 强度要求：长度 `>=12` 且命中常见弱口令/弱模式则拒绝
- 直连门禁：
  - 必须提供 `DIRECT_URL`，seed 内部会将 `DATABASE_URL` 覆盖为 `DIRECT_URL`，避免 pooler 带来的不确定性

### 3.2 防并发锁（Postgres advisory lock）
- 使用 transaction-level lock（更适配 Prisma 连接池）：
  - `SELECT pg_advisory_xact_lock(hashtext('seed_prod_lock'));`
- 目的：避免重复触发/并发执行导致的写冲突（即使 workflow concurrency 失效，也能兜底）。

---

## 4) GitHub Environments 配置文档

- `docs/08_Deployment_and_Ops/GITHUB_ENV_PRODUCTION.md`

包含：
- 创建 `production` environment
- required reviewers（至少 1 人）
- environment secrets：`DATABASE_URL`、`DIRECT_URL`、`SEED_ADMIN_PASSWORD`（可选 `SEED_COACH_PASSWORD`）

---

## 5) 运行方式（本地 / CI）

### 5.1 本地（推荐：只跑只读/不连 DB 的校验）
- 校验内容资产（不连 DB）：
  - `npm run content:validate`

### 5.2 本地（只读验收，需连 DB）
- 只读 smoke gate（默认使用 `DIRECT_URL` 覆盖 `DATABASE_URL`）：
  - 设置：`DATABASE_URL` + `DIRECT_URL`
  - 运行：`npm run smoke:prod-gate`

### 5.3 本地（生产 seed：默认禁止，需显式解锁）
仅用于紧急/手工场景（不建议常态化）：
- 设置：
  - `ALLOW_PROD_SEED=true`
  - `DIRECT_URL=...`
  - `SEED_ADMIN_PASSWORD=...`
- 运行：
  - `npm run seed:prod`

### 5.4 CI（推荐的生产流程）
- push/merge 到 `main` → 触发 `.github/workflows/db-deploy.yml`
- 如启用 required reviewers：需要审批后才会执行 migrate/seed

---

## 6) Vercel 解耦说明（必须）

- `vercel.json` 的 `buildCommand` 已调整为：
  - `npm run db:generate && npm run build`
- 注意：如果你在 Vercel UI 里手动配置过 Build Command，请同步移除 migrate/seed（避免 Preview/并发部署写脏生产库）。

---

## 7) Actions 故障排查记录（logs_53713469896.zip）

### 7.1 现象
- GitHub Actions `DB Deploy` 在 `Seed prod (idempotent + gates + advisory lock)` 步骤失败并退出。

### 7.2 日志关键报错
- `PrismaClientKnownRequestError (P2010)`
- `Failed to deserialize column of type 'void'`
- 触发点：`SELECT pg_advisory_xact_lock(...)` 通过 Prisma `$queryRaw` 执行时，返回类型 `void` 导致 Prisma 反序列化失败。

### 7.3 根因
- `pg_advisory_xact_lock` 在 Postgres 中返回 `void`。
- Prisma 的 `$queryRaw` 会尝试反序列化查询结果列，遇到 `void` 类型会报错。

### 7.4 修复
- 文件：`prisma/seed.prod.ts`
- 将锁语句从 `$queryRaw` 改为 `$executeRaw`（执行但不反序列化结果）：
  - `await tx.$executeRaw\`SELECT pg_advisory_xact_lock(hashtext('seed_prod_lock'))\`;`

### 7.5 复跑建议
- 修复合并到 `main` 后，重新触发 `.github/workflows/db-deploy.yml`（push 或 `workflow_dispatch`）即可验证。
