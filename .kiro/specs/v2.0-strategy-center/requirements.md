# V2.0 策略中心 需求文档

## 概述
本次迭代为策略中心阶段（2周），聚焦 SOP+话术合并、标签管理、配置影响预览等核心功能，建立标签驱动策略引擎基础框架。

**核心目标**：
- 配置入口从 4 个减少到 2 个
- 消除 SOP Rule 和话术 triggerTags 的重复配置
- 建立标签驱动策略引擎基础框架

---

## 功能模块

### 1. 策略中心模块（SOP+话术合并）

#### 1.1 统一入口
- **现状**: SOP 配置和话术库分开管理，配置分散
- **需求**: 新建"策略中心"页面，整合 SOP 和话术
- **页面结构**:
  - 左侧：策略列表（按陪跑阶段分组）
  - 右侧：策略详情（含关联话术）
- **终局模型支持**: 是（阶段：全陪跑阶段；标签逻辑：SOP 触发标签驱动）

#### 1.2 验收标准
- [ ] 策略中心页面可访问
- [ ] 按阶段（pre/mid/post）分组展示策略
- [ ] 策略详情显示关联话术
- [ ] 可从策略中心创建/编辑策略

---

### 2. 话术关联 SOP 重构

#### 2.1 数据模型调整
- **现状**: 话术和 SOP 独立配置，triggerTags 重复
- **需求**: 话术增加 sopId 字段，关联到 SOP
- **数据库变更**:
  ```prisma
  model ScriptTemplate {
    sopId String? @map("sop_id")
    sop   SopDefinition? @relation(fields: [sopId], references: [sopId])
  }
  ```
- **终局模型支持**: 是（标签逻辑：统一策略触发条件）

#### 2.2 匹配逻辑调整
- **需求**: 话术推荐优先返回关联 SOP 的话术
- **逻辑**: 
  1. 根据客户标签匹配 SOP
  2. 返回该 SOP 关联的话术
  3. 补充独立话术

#### 2.3 验收标准
- [ ] ScriptTemplate 表新增 sopId 字段
- [ ] 话术可关联到 SOP
- [ ] 关联话术优先展示

---

### 3. 标签管理中心

#### 3.1 标签统一管理
- **现状**: 标签分散在各处，无统一管理
- **需求**: 新建标签管理页面
- **功能**:
  - 查看所有标签定义
  - 标签分类：画像标签、阶段标签、分层标签、自定义标签
  - 标签使用统计
  - 标签依赖关系展示
- **终局模型支持**: 是（标签逻辑：标签体系治理）

#### 3.2 验收标准
- [ ] 标签管理页面可访问
- [ ] 显示所有标签及分类
- [ ] 显示标签使用统计

---

### 4. 配置影响预览功能

#### 4.1 影响预览
- **需求**: 策略配置时预览影响范围
- **功能**:
  - 根据触发条件计算匹配客户数
  - 显示画像分布
  - 显示阶段分布
- **终局模型支持**: 间接支持（标签逻辑：策略影响监控）

#### 4.2 验收标准
- [ ] 预览 API 可用
- [ ] 返回匹配客户数
- [ ] 返回画像/阶段分布

---

## 文件变更清单

```
app/admin/strategy/page.tsx             # 新建 - 策略中心页面
app/admin/tags/page.tsx                 # 新建 - 标签管理页面
app/api/admin/strategy/preview/route.ts # 新建 - 影响预览 API
prisma/schema.prisma                    # 修改 - 添加 sopId 字段
app/api/coach/scripts/route.ts          # 修改 - 话术匹配逻辑
```

---

## 工时估算

| 任务 | 工时 | 终局模型 |
|------|------|----------|
| 策略中心页面开发 | 5d | 是 |
| 话术关联 SOP 重构 | 2.5d | 是 |
| 标签管理中心 | 2d | 是 |
| 配置影响预览 API | 1.5d | 间接 |
| 原 SOP/话术页面兼容 | 1d | 否 |
| **总计** | **12d** | |

---

## 优先级
1. 话术关联 SOP 重构（数据基础）
2. 策略中心页面（核心功能）
3. 标签管理中心（治理工具）
4. 配置影响预览（辅助功能）
